<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/app-route/app-location.html">
<link rel="import" href="/bower_components/app-route/app-route.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<dom-module name="page-container" attributes="defaultPage">
	<style>
		#tofill > * {
			position: fixed;
			left: 0;
			top: 0;
			right: 0;
			bottom: 0;
		}
	</style>

	<template id="page-container">
		<app-location route="{{route}}"></app-location>
		<app-route id="baseRoute"
			route="{{route}}"
			pattern="/:x"
			data="{{routeData}}"
			tail="{{subroute}}"
			query-params="{{queryParams}}">
		</app-route>
		<app-route
			route="{{subroute}}"
			pattern="/:x"
			data="{{subrouteData}}">
		</app-route>

		<iron-ajax
			id="dictLoader"
			auto
			url="/route-dict.json"
			handle-as="text"
			last-response="{{textDict}}"
			debounce-duration="300"></iron-ajax>

		<div id="tofill"></div>
	</template>

	<script>
		Polymer({
			is: "page-container",
			listeners: {
			},
			observers: [
				'routeChanged(contentName, subrouteData.x, subroute.path, queryParams)'
			],
			properties: {
				textDict: {
					type: String,
					value: '{"": "htwg-image"}'
				},
				routeDict: {
					type: Object,
					computed: "jsonToOject(textDict)"
				},
				routeData: {
					type: Object,
					value: {"x": ""},
					notify: true
				},
				subrouteData: {
					type: Object,
					value: {"x": ""},
					notify: true
				},
				contentName: {
					type: String,
					computed: 'translateRoute(routeData.x)',
					notify: true
				},
				jsonParams: {
					type: String,
					computed: 'stringifyParams(queryParams)'
				}
			},
			ready: function() {
				this.routeDict[""] = this.defaultPage;
			},
			translateRoute: function(page) {
				if (page in this.routeDict) {
					return this.routeDict[page];
				}
				
				console.log("No match for " + page);
				
				if (this.routeDict[""]) {
					console.log("Using no-path page");
					return this.routeDict[""];
				}
				return "htwg-image";
			},
			routeChanged: function(nodeName, arg, isVaildArg, options) {
				this.debounce("insertNode", this.insertPolymerNode, 100);
			},
			insertPolymerNode: function() {
				var nodeName = this.contentName;
				var arg = this.subrouteData.x;
				var isVaildArg = this.subroute.path;
				var options = this.queryParams;
				
				var el = document.createElement("link");
				el.rel = "import";
				el.href = "/app/elements/" + nodeName + ".html";
				Polymer.dom(this.root).appendChild(el);
				
				el = document.createElement(nodeName);
				if (isVaildArg) {
					el.arg = arg;
				}
				var cont = Polymer.dom(tofill);
				cont._clear();
				cont.appendChild(el);
			},
			stringifyParams: function(params) {
				return JSON.stringify(params);
			},
			jsonToOject: function(text) {
				return JSON.parse(text);
			}
		});
	</script>
</dom-module>